name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build-macos:
    name: Build macOS (${{ matrix.target }})
    runs-on: macos-15
    strategy:
      matrix:
        include:
          - target: aarch64-apple-darwin
            arch: arm64
          - target: x86_64-apple-darwin
            arch: x86_64

    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Select Xcode
        run: sudo xcode-select -s /Applications/Xcode_16.2.app

      - name: Run Rust tests
        if: matrix.target == 'aarch64-apple-darwin'
        run: cargo test --release

      - name: Build and bundle
        run: ./scripts/bundle-macos.sh --target ${{ matrix.target }}

      - name: Sign and notarize
        id: sign
        if: secrets.APPLE_IDENTITY != ''
        env:
          APPLE_IDENTITY: ${{ secrets.APPLE_IDENTITY }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_APP_PASSWORD: ${{ secrets.APPLE_APP_PASSWORD }}
        run: |
          # Import certificate from secrets
          CERTIFICATE_PATH=$RUNNER_TEMP/certificate.p12
          KEYCHAIN_PATH=$RUNNER_TEMP/signing.keychain-db
          echo -n "${{ secrets.APPLE_CERTIFICATE_P12 }}" | base64 --decode -o $CERTIFICATE_PATH
          security create-keychain -p "" $KEYCHAIN_PATH
          security set-keychain-settings -lut 21600 $KEYCHAIN_PATH
          security unlock-keychain -p "" $KEYCHAIN_PATH
          security import $CERTIFICATE_PATH -P "${{ secrets.APPLE_CERTIFICATE_PASSWORD }}" -A -t cert -f pkcs12 -k $KEYCHAIN_PATH
          security set-key-partition-list -S apple-tool:,apple: -k "" $KEYCHAIN_PATH
          security list-keychains -d user -s $KEYCHAIN_PATH login.keychain-db

          # Sign and notarize
          ./scripts/sign-and-notarize.sh dist/cctop.app

          # Re-create the zip with signed app
          rm -f dist/cctop-macOS.zip
          cd dist && ditto -c -k --sequesterRsrc --keepParent cctop.app cctop-macOS.zip

          echo "signed=true" >> "$GITHUB_OUTPUT"

      - name: Clean up signing keychain
        if: always() && steps.sign.outcome != 'skipped'
        run: |
          KEYCHAIN_PATH=$RUNNER_TEMP/signing.keychain-db
          security delete-keychain $KEYCHAIN_PATH 2>/dev/null || true
          rm -f $RUNNER_TEMP/certificate.p12

      - name: Rename zip for release
        run: mv dist/cctop-macOS.zip dist/cctop-macOS-${{ matrix.arch }}.zip

      - name: Install create-dmg
        run: brew install create-dmg

      - name: Create DMG
        run: ./scripts/create-dmg.sh --arch ${{ matrix.arch }}

      - name: Upload zip artifact
        uses: actions/upload-artifact@v4
        with:
          name: cctop-macOS-${{ matrix.arch }}
          path: dist/cctop-macOS-${{ matrix.arch }}.zip

      - name: Upload DMG artifact
        uses: actions/upload-artifact@v4
        with:
          name: cctop-macOS-${{ matrix.arch }}-dmg
          path: dist/cctop-macOS-${{ matrix.arch }}.dmg

  release:
    name: Create Release
    needs: build-macos
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Build release body
        id: body
        env:
          IS_SIGNED: ${{ secrets.APPLE_IDENTITY != '' }}
        run: |
          BODY="## Installation

          ### macOS (Apple Silicon)
          \`\`\`bash
          # Download and extract
          curl -sL https://github.com/st0012/cctop/releases/download/${{ github.ref_name }}/cctop-macOS-arm64.zip -o cctop.zip
          unzip cctop.zip
          mv cctop.app /Applications/

          # Launch
          open /Applications/cctop.app
          \`\`\`

          ### macOS (Intel)
          \`\`\`bash
          curl -sL https://github.com/st0012/cctop/releases/download/${{ github.ref_name }}/cctop-macOS-x86_64.zip -o cctop.zip
          unzip cctop.zip
          mv cctop.app /Applications/
          open /Applications/cctop.app
          \`\`\`

          ### From source
          Requires [Rust](https://rustup.rs/) and Xcode.
          \`\`\`bash
          git clone https://github.com/st0012/cctop && cd cctop
          cargo install --path .                    # TUI + hook
          ./scripts/bundle-macos.sh                 # menubar app
          cp -R dist/cctop.app /Applications/
          \`\`\`"

          if [ "$IS_SIGNED" = "true" ]; then
            BODY="$BODY

          > This release is signed and notarized by Apple."
          else
            BODY="$BODY

          > **Note:** This release is not notarized. On first launch, you may need to
          > right-click the app and select \"Open\", or go to System Settings > Privacy &
          > Security and click \"Open Anyway\"."
          fi

          # Write to file to avoid quoting issues
          echo "$BODY" > "$RUNNER_TEMP/release-body.md"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          draft: false
          generate_release_notes: true
          files: |
            artifacts/cctop-macOS-arm64/cctop-macOS-arm64.zip
            artifacts/cctop-macOS-x86_64/cctop-macOS-x86_64.zip
            artifacts/cctop-macOS-arm64-dmg/cctop-macOS-arm64.dmg
            artifacts/cctop-macOS-x86_64-dmg/cctop-macOS-x86_64.dmg
          body_path: ${{ runner.temp }}/release-body.md

  update-homebrew:
    name: Update Homebrew Tap
    needs: release
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Compute SHA256 hashes
        id: sha
        run: |
          ARM64_SHA=$(sha256sum artifacts/cctop-macOS-arm64/cctop-macOS-arm64.zip | awk '{print $1}')
          X86_64_SHA=$(sha256sum artifacts/cctop-macOS-x86_64/cctop-macOS-x86_64.zip | awk '{print $1}')
          echo "arm64=$ARM64_SHA" >> "$GITHUB_OUTPUT"
          echo "x86_64=$X86_64_SHA" >> "$GITHUB_OUTPUT"

      - name: Extract version from tag
        id: version
        run: |
          VERSION="${GITHUB_REF_NAME#v}"
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"

      - name: Stamp cask template
        run: |
          sed -i 's/version ".*"/version "${{ steps.version.outputs.version }}"/' packaging/homebrew-cask.rb
          sed -i 's/REPLACE_WITH_ARM64_SHA256/${{ steps.sha.outputs.arm64 }}/' packaging/homebrew-cask.rb
          sed -i 's/REPLACE_WITH_X86_64_SHA256/${{ steps.sha.outputs.x86_64 }}/' packaging/homebrew-cask.rb

      - name: Clone tap repo and update cask
        env:
          TAP_GITHUB_TOKEN: ${{ secrets.TAP_GITHUB_TOKEN }}
        run: |
          git clone https://x-access-token:${TAP_GITHUB_TOKEN}@github.com/st0012/homebrew-cctop.git tap
          mkdir -p tap/Casks
          cp packaging/homebrew-cask.rb tap/Casks/cctop.rb
          cd tap
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Casks/cctop.rb
          git commit -m "Update cctop to ${{ steps.version.outputs.version }}"
          git push
